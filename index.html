<head>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>

<style>
    .node {
  font: 10px sans-serif;
}

.link {
  stroke: steelblue;
  stroke-opacity: 0.5;
  fill: none;
  pointer-events: none;
}
</style>


<body>
    <div id="general_viz" class="row bg-dark m-0 p-1">
        <div class=" titre row my-5">
          <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
              Bonjjour
          </div>

          <div id="genres" class="col bg-light overflow-auto rounded m-1"> 
          </div>

          <div id="genres-details" class="col-2 bg-light overflow-auto rounded m-1">
          </div>
        </div>

        <div class="row my-5">
          <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
            Bonjjour
          </div>
          <div id="top-artists" class="col bg-light overflow-auto rounded m-1"> 
          </div>

          <div id="top-artists-details" class="col-2 bg-light overflow-auto rounded m-1">
          </div>
        </div>

        <div class="row my-5">
          <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
            Bonjjour
          </div>
          <div id="artists" class="col bg-light overflow-auto rounded m-1"> 
          </div>
  
          <div id="artists-details" class="col-2 bg-light overflow-auto rounded m-1">
          </div>
          </div>

        <div class="row my-5">
          <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
            Bonjjour
          </div>

          <div id="songs" class="col bg-light overflow-auto rounded m-1 "> 
          </div>

          <div id="songs-details" class="col-2 bg-light overflow-auto rounded m-1">
          </div>
      </div>
   </div>
</body>

<script>
    function filterMostListen(dicoGenres,seuil) {
        var valuesArray = Object.values(dicoGenres);
        valuesArray.sort((a, b) => b - a);
        var val_seuil = valuesArray[Math.floor(valuesArray.length * seuil)];
        var filteredDicoGenre = Object.fromEntries(
            Object.entries(dicoGenres).filter(([key, value]) => value >= val_seuil)
        );
        return filteredDicoGenre;
    }

    function getArtistsByGenres(genres,artists){
        var resultatsFiltres = artists.filter(function(element) {
            return element.genres.some(function(genre) {
                return genres.includes(genre);
        });
    });
    return resultatsFiltres;
    }

    function filterOccurence(artists_to_keep, artists) {
        filtered_artists = {}
        for(var artist in artists) {
            if(artists_to_keep.some(function (element) {return element.name === artist;})){
                filtered_artists[artist] = artists[artist]
                //filtered_artists.push({"artist":artist,"occurence":artists[artist]})
            }
        }
        return filtered_artists
    }

    function getSongsByArtists(artists,songs) {

    }

   

    function plotHist(dataGenres,divName){
        tooltip = d3
            .select('#genres')
            .append('div')
            .attr('class', 'd3-tooltip')
            .style('position', 'absolute')
            .style('visibility', 'hidden')
            .style('background', 'rgba(0,0,0,0.6)')
            .style('border-radius', '4px')
            .style('color', '#fff')
        const w = Object.keys(dataGenres).length*6;
        const h = 250;
        const yScale = d3.scaleSqrt()
                .domain([1, d3.max(Object.entries(dataGenres), d => +d[1])])
                .range([0, h]);

        const barWidth = 5
        const barSpacing = 1
        const svg = d3.select("#"+divName)
                  .append("svg")
                  .attr("width", w)
                  .attr("height", h);

        const bars = svg.selectAll("rect")
                .data(Object.entries(dataGenres))
                .enter()
                .append("g");

        bars.append("rect")
                .attr("x", (d, i) => i * (barWidth + barSpacing))
                .attr("y", (d, i) => (h -  yScale(d[1]))/2)
                .attr("width", barWidth)
                .attr("height", (d, i) => (yScale(d[1])))
                .attr("fill", (d, i) => i % 2 === 0 ? "#1DB954" : "#000000")  
                .attr("class", "bar");

        d3.selectAll("rect")
                .on('mouseover', function (d, i) {
                    tooltip
                        .html(`<div>${this.__data__[0]}</div>`)
                        .style('visibility', 'visible');
                })
                .on('mouseout', function (d,i) {
                    tooltip
                        .html(``).style('visibility', 'hidden')
      });          
    }

    d3.json("datasets/occurences/occurences_genres_elliot.json").then(function (dataGenres) {
        filteredGenres = filterMostListen(dataGenres,0.25)
        plotHist(filteredGenres,"genres");
        d3.json("datasets/tracks/artists_elliot.json").then(function (artists_elliot){
            filteredArtistsByGenre = getArtistsByGenres(Object.keys(filteredGenres),artists_elliot)
            d3.json("datasets/occurences/occurences_artists_elliot.json").then(function (occurences_artists_elliot){
                filteredArtistsOccurence = filterOccurence(filteredArtistsByGenre,occurences_artists_elliot)
                filteredArtistsOccurence = filterMostListen(filteredArtistsOccurence,0.25)
                //plotArtistsNameCloud(filteredOccurence)
                plotHist(filteredArtistsOccurence,"artists")
                plotHist(filteredArtistsOccurence,"songs")
                plotHist(filteredArtistsOccurence,"top-artists")


                d3.json("datasets/occurences/occurences_artists_elliot.json").then(function (occurences_artists_elliot){

                });



            })
        })
        

    })

    function plotArtistsNameCloud(artists) {
        var myWords = artists
        
        var margin = {top: 10, right: 10, bottom: 10, left: 10},
            width = 250 - margin.left - margin.right,
            height = 250 - margin.top - margin.bottom;

        var svg = d3.select("#artists").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");

        var layout = d3.layout.cloud()
          .size([width, height])
          .words(myWords.map(function(d) { return {text: d.artist, size:d.occurence}; }))
          .padding(5)        //space between words
          .rotate(function() { return ~~(Math.random() * 2) * 90; })
          .fontSize(function(d) { return d.size; })      // font size of words
          .on("end", draw);
        layout.start();

        
        function draw(words) {
          svg
            .append("g")
              .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
              .selectAll("text")
                .data(words)
              .enter().append("text")
                .style("font-size", function(d) { return d.size; })
                .style("fill", (d) => d.size % 2 === 0 ? "#1DB954" : "#000000")
                .attr("text-anchor", "middle")
                .attr("transform", function(d) {
                  return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function(d) { return d.text; });
        }}
        
        
</script>
