<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<html>
  <body class="w-screen h-screen">

    <div id="rangeDiv" class="bg-slate-600 h-2/4 w-full">

    </div>

    <script type="module">

      async function getHistory(file) {
        const raw = await d3.json('./datasets/raw/elliot/Streaming_History_Audio_2019-2020_1.json')
        return raw.map( h => {
          h.ts = new Date(h.ts)
          return h
        })
      }


      
      const elliotHistory = await getHistory('./datasets/raw/elliot/Streaming_History_Audio_2019-2020_1.json')

      const groupByDay = d3.groups(elliotHistory, (d) => {
        return new Date(d.ts.toDateString())
      })

      groupByDay.forEach(day => {
        const [i, historyOfDay] = day;
        day.msPlayedTotal = d3.sum(historyOfDay, d => d.ms_played);
      });

      const width = 300
      const height = 30

      const space = 8

      const rangeSvg =  d3.select("#rangeDiv")
        .append("svg")
        .attr("id", "rangesvg")
        .attr("viewBox", [0, 0, width, height])
        .style("background-color", "silver")

      rangeSvg.append("rect").attr("x",299).attr("y",0).attr("width",1).attr("height",1)

      const timeScale = d3.scaleTime([d3.min(groupByDay, h => h[0]), d3.max(groupByDay, h => h[0])],[0,width])
      const timeListenningScale = d3.scaleTime([d3.min(groupByDay, h => h.msPlayedTotal), d3.max(groupByDay, h => h.msPlayedTotal)],[0,height - space])


      rangeSvg.append("g")
              .selectAll("rect")
              .data(groupByDay)
              .enter()
              .append("rect")
              .attr("x", (d, i) => timeScale(d[0]) - width * 0.5 / groupByDay.length)
              .attr("y", (d, i) =>{
                return height-space-timeListenningScale(d.msPlayedTotal)
              })
              .attr("width", width / groupByDay.length)
              .attr("height", (d) => timeListenningScale(d.msPlayedTotal))

      

      const bottomAxis =  d3.axisBottom(timeScale)
                            .ticks(d3.timeMonth.every(1))
                            .tickSize(2)
                            .tickFormat(function(date){
                              if (d3.timeYear(date).getMonth() < date.getMonth()) {
                                return d3.timeFormat('%b')(date);
                              } else {
                                return d3.timeFormat('%Y')(date);
                              }
                            });

      const brush = d3.brushX()
        .extent([[0, 0], [width, height]])
        //.on("brush", brushed)
        //.on("end", brushended);

      rangeSvg.append("g")
        .call(brush)

      rangeSvg.append("g")
              .call(bottomAxis)
              .attr("transform", "translate(0," + (timeListenningScale(d3.max(groupByDay, h => h.msPlayedTotal)))+")")
              .style("font-size",3);



    </script>
    
  </body>
</html> 