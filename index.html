<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"
  ></script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <script src="dataManagement.js"></script>
  <script src="artists.js"></script>
  <script src="genres.js"></script>
  <script src="topArtists.js"></script>
</head>

<style>

 

  .dates {
      font-family: "Verdana";
      font-size: 3em;
  }

  .pie text {
      font-family: "Verdana";
      fill: #888;
  }



  .pie .name-text{
      font-size: 1.5em;
  }

  .pie .value-text{
      font-size: 3em;
  }
  */
</style>

<body>
  <div class="container">
    <select id="subject" class="form-select my-2" onchange="selectSubject()">
      <option selected value="elliot">Elliot</option>
      <option value="elodie">Elodie</option>
    </select>
  </div>
  <div class="container fixed-bottom bg-body">
    <div id="brush" class="row bg-light overflow-auto rounded m-1"></div>
    <div class="row justify-content-center dates">&zwnj;</div>
  </div>

  <div class="container">

    <div id="general_viz" class="row m-0 p-1">
      <div class="titre row my-5">
        <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
          <h2>Les top genres musicaux</h2>
        </div>

        <div id="genres" class="col bg-light overflow-auto rounded m-1"></div>

        <div
          id="genres-details"
          class="col-2 bg-light overflow-auto rounded m-1"
        ></div>
      </div>

      <div class="row my-5">

        <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
          <h2>Les 10 artistes les plus écoutés</h2>
          </div>
          <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
          <div id="firstfive" class="col-md-6"></div>
          <div id="lastfive" class="col-md-6"></div>
          </div>
        </div>
        <div id="top-artists" class="col bg-light overflow-auto rounded m-1">
          <div id="firstfive" class="col-md-6"></div>
          <div id="lastfive" class="col-md-6"></div>
        </div>

        <div
          id="top-artists-details"
          class="col-2 bg-light overflow-auto rounded m-1"
        ></div>
      </div>

      <div class="row my-5">
        <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
          <h2>Les artistes</h2>
        </div>
        <div class="col bg-light overflow-auto rounded m-1 p-3">
          <div class="titre row">
            <div class="row">
              <div
                id="artists"
                class="col bg-light overflow-auto rounded text-center"
              ></div>
              <div
                id="detailedArtists"
                class="col bg-light overflow-auto rounded"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row my-5">
        <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
          <h2>Les sons</h2>
        </div>

        <!--
        <div id="songs" class="col bg-light overflow-auto rounded m-1"></div>
        -->

        <div
          id="songs-details"
          class="bg-light overflow-auto rounded m-1"
        ></div>
      </div>

      <div class="row my-5">
        <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
          <h2>Les sons</h2>
        </div>

        <div  class="col bg-light overflow-auto rounded m-1"></div>

        <div
          class="col-2 bg-light overflow-auto rounded m-1"
        ></div>
      </div>
    </div>
  </div>
</body>

<script type="module">
  window.global = {
    subject: document.getElementById("subject").value,
    fullHistory: null,
    fullArtists: null,
    fullAlbums: null,
    fullTracks: null,

    startTimestampFilter: null,
    endTimestampFilter: null,

    historyFiltered: null,
    artistFiltered: null,
    albumsFiltered: null,
    fullTracksFiltered: null,

    mainArtistSelected: true,

    tracksX: null,
    tracksY: null,
    tracksData: null,
    trackColorScale: null,

  };

  await loadFullData();

  window.global.historyFiltered = window.global.fullHistory;
  window.global.artistFiltered = window.global.fullArtists;
  window.global.albumsFiltered = window.global.fullAlbums;
  window.global.fullTracksFiltered = window.global.fullTracks;

  window.global.startTimestampFilter = d3.min(window.global.historyFiltered, x => x.ts)
  window.global.endTimestampFilter = d3.max(window.global.historyFiltered, x => x.ts)

  const groupedHistoryByTracks = d3.group(
    window.global.fullHistory,
    (d) => d.trackId
  );

  const result = Array.from(groupedHistoryByTracks, ([key, values]) => ({
    artist: key,
    totalTs: d3.sum(values, (d) => d.ms_played),
  }));

  const totalMs = d3.sum(result, (d) => d.totalTs);

  result.forEach((d) => {
    d.totalTs = (d.totalTs * 100) / totalMs;
  });

  result.sort(function (x, y) {
    return d3.descending(x.totalTs, y.totalTs);
  });

  artistsSelector();
  artistsDetails();
  brush();
  genresViz();
  topArtistsViz()
  tracks()

  setTimeout(function() {
    d3.select("#selectorMainArtistsPath")
    .node()
    .dispatchEvent(new MouseEvent("click"));
  d3.select("#selectorMainArtistsG")
    .node()
    .dispatchEvent(new MouseEvent("click"));
  }, 10);

  var select = document.getElementById("subject");
  select.addEventListener("change", async () => {
    await selectSubject()
    brush()
    updateAll()
  });

  function tracks() {
    var h = window.global.historyFiltered

    const format = d3.utcFormat("%d-%m-%Y");
    const parseTime = d3.utcParse("%d-%m-%Y");

    h.forEach(d => {
      d.ts = parseTime(format(d.ts))
    });

    h = d3.group(h, d => d.trackId, d => d.ts)

    var dateRange = d3.timeDays(window.global.startTimestampFilter, window.global.endTimestampFilter)
    dateRange = dateRange.map( d => parseTime(format(d)))

    var tmp = []
    // Pour chaque track
    h.forEach((value, key) => {
      var s = []
      dateRange.forEach((date) => {
        if(value.has(date)) {
          s.push(value.get(date))
        }else {
          s.push([])
        }
      })
      tmp.push({
        trackId: key,
        series: s,
        mean: null
      })
    })

    h = tmp

    h.forEach( (t) => {
      t.series = t.series.map( s => {
        if(s.length === 0){
          return 0
        } else {
          return d3.sum(s, s=>s.ms_played)
        }
      })
    })

    var interval = 29
    var intervalTruc = interval - (interval-1)/2 
    
    dateRange = dateRange.slice(intervalTruc-1, dateRange.length-intervalTruc+2)

    h.map( x => {
      x.mean = d3.mean(x.series)
      x.series = movingAverage(x.series, interval).map(x => x/3600)
    })


    var sortedH = [...h].sort(function(x, y){
      return d3.descending(x.mean, y.mean);
    })

    sortedH = sortedH.slice(0,200).map(d => d.trackId)
    

    h = h.filter( x => sortedH.includes(x.trackId))


    var data = {
      tracks: h.map(x => x.trackId),
      series: h.map(x => {
        return {
          values: x.series,
          trackId: x.trackId,
          mean: x.mean
        }
      }),
      dates: dateRange
    }


    window.global.tracksData = data


    // https://observablehq.com/@mguiv/construire-un-graphique-pas-a-pas-avec-d3-js

    var height = 500
    var width = 800

    var margin = ({top: 20, right: 20, bottom: 30, left: 30})

    window.global.tracksX = d3.scaleUtc()
      .domain(d3.extent(dateRange))
      .range([margin.left, width - margin.right])

    window.global.tracksY = d3.scaleLinear()
      .domain([0, d3.max(data.series, d => d3.max(d.values))]).nice()
      .range([height - margin.bottom, margin.top])

    var line = d3.line() // trace une ligne
            .defined(d => !isNaN(d)) // on supprime les valeurs manquantes
            .x((d, i) => window.global.tracksX(data.dates[i])) // renvoie la date à l'instant i
            .y(d => window.global.tracksY(d)) // renvoie les taux de chômages

    var xAxis = g => g
      .attr("transform", `translate(0,${height - margin.bottom})`) // on déplace l'axe en bas du graphe
      .call(d3.axisBottom(window.global.tracksX).ticks(width / 40).tickSizeOuter(0)) // ticks permet de spécifier le nombre de graduation 
                                                       //tickSizeOuter(0) supprime les bordures verticales sur l'axe


    var yAxis = g => g
      .attr("transform", `translate(${margin.left},0)`) // on déplace l'axe à gauche
      .call(d3.axisLeft(window.global.tracksY)) // axe de gauche avec les valeurs de y()
      //.call(g => g.select(".domain").remove())
      .call(g => g.select(".tick:last-of-type text").clone() // on définit le type de texte à afficher, le style...
          .attr("x", 3)
          .attr("text-anchor", "start")
          .attr("font-weight", "bold")
          .text(() => {
            return "Temps d'écoute moyen (moyenne glissante) en minutes"
          }))

    d3.select("#tracksSvg").remove()

    const svg = d3.select("#songs-details")
                  .append("svg")
                  .attr("id", "tracksSvg")
                  .attr("viewBox", [0, 0, 800, 500]) // dimensions
                  .style("overflow", "visible");

    svg.append("g")
      .call(xAxis);
    svg.append("g")
      .call(yAxis);

    console.log("data", data)

    
    window.global.trackColorScale = d3.scaleSequential().domain([d3.max(data.series, x => x.mean),d3.min(data.series, x => x.mean)])
      .interpolator(d3.interpolateSpectral);
    

    const path = svg.append("g")
                    .attr("fill", "none") // on laisse l'arrière-plan vide
                    .attr("stroke-width", 1.5)  // taille de la ligne
                    .attr("stroke-linecap", "round") //type de ligne
                    .selectAll("path")
                    .data(data.series)
                    .join("path")
                    .attr ('stroke', d=>window.global.trackColorScale(d.mean))
                    .style("mix-blend-mode", "multiply") // option de style
                    .attr("d", d => line(d.values)); // trace la valeur du taux de chômage (values) associée à un lieu (y) à la date i (x)

    svg.call(hoverTracks, path); // on passe path en argument pour la fonction hover
  }

  function hoverTracks(svg, path) {
  
    if ("ontouchstart" in document) svg
        .style("-webkit-tap-highlight-color", "transparent")
        .on("touchmove", moved)
        .on("touchstart", entered)
        .on("touchend", left)
    else svg
        .on("mousemove", moved)
        .on("mouseenter", entered)
        .on("mouseleave", left);

    const dot = svg.append("g")// construction d'un conteneur
        .attr("display", "none");
    
    // création du panneau qui s'affichera au-dessus des courbes
    dot.append("polyline") // construction du panneau vide --> on utilise polyline plutôt que de fusionner un rectangle et un triangle
        .attr("points","0,0 0,144 432,144, 432,0 0,0") // dimensions du panneau
        .attr("id", "polyLineTracks")
        .style("fill", "#fafafa")
        .style("stroke"," #5dade2 ")
        .style("opacity","0.8") // légère transparence
        .style("stroke-width","1")
        .attr("transform", "translate(-215, -170)"); // translation du panneau

    // création du cercle noir sous le panneau qui indique le point précis où l'on se situe
    dot.append("circle")
        .attr("r", 6.5);

    // texte pour les noms de lieux
    dot.append("text")
        .attr("font-weight", "bold")
        .attr("font-size", 18)
        .attr("text-anchor", "middle")
        .attr("id", "dot-name") //  on donne un identifiant à ce texte
        .attr("dx", "0")
        .attr("dy", "-130")
        .attr("class", "trackText")
    
    // création d'une puce (rond bleu dans le panneau)      
    dot.append("text")
        .attr("font-size", 20)
        .style("fill", "#FF0000")
        .attr("dx", "-200")
        .attr("dy", "-90")
        .attr("class", "trackText")
        .text("●");
    
    // création du texte pour les dates
    dot.append("text")
        .attr("font-family", "sans-serif")
        .attr("font-size", 16)
        .attr("dx", "-180")
        .attr("dy", "-90")
        .attr("class", "trackText")
        .attr("id", "dot-date"); // identifiant date

    // création de la deuxième puce
    dot.append("text")
        .attr("font-size", 20)
        .style("fill", "#FF0000")
        .attr("dx", "-200")
        .attr("dy", "-50")
        .attr("class", "trackText")
        .text("●");
    
    // texte pour les taux de chômage
    dot.append("text")
          .attr("font-size", 16)
          .attr("dx", "-180")
          .attr("dy", "-50")
          .attr("class", "trackText")
          .attr("id", "dot-values") // identifiant

    // -------------------------------------------

    // création d'une puce (rond bleu dans le panneau)      
    dot.append("text")
        .attr("font-size", 20)
        .style("fill", "#FF0000")
        .attr("dx", "20")
        .attr("dy", "-90")
        .attr("class", "trackText")
        .text("●");
    
    // création du texte pour les dates
    dot.append("text")
        .attr("font-family", "sans-serif")
        .attr("font-size", 16)
        .attr("dx", "40")
        .attr("dy", "-90")
        .attr("class", "trackText")
        .attr("id", "dot-datee"); // identifiant date

    // création d'une puce (rond bleu dans le panneau)      
    dot.append("text")
        .attr("font-size", 20)
        .style("fill", "#FF0000")
        .attr("dx", "20")
        .attr("dy", "-50")
        .attr("class", "trackText")
        .text("●");
    
    // création du texte pour les dates
    dot.append("text")
        .attr("font-family", "sans-serif")
        .attr("font-size", 16)
        .attr("dx", "40")
        .attr("dy", "-50")
        .attr("class", "trackText")
        .attr("id", "dot-listen"); // identifiant date

    
  // associe l'affichage du panneau et la transparence des courbes non sélectionnées aux actions de la souris    
    function moved(event) {
      event.preventDefault(); // change les valeurs par défaut affectées aux actions (clics, mouvement de la souris...)
      const pointer = d3.pointer(event, this); // on construit un pointeur (tableau des coordonnées pour l'évènement this)


      const xm = window.global.tracksX.invert(pointer[0]); // retourne le range associé à la coordonnée en x
      const ym = window.global.tracksY.invert(pointer[1]); // retourne le range associé à la coordonné en y
      const i = d3.bisectCenter(window.global.tracksData.dates, xm); // index de la valeur de la date la plus proche de xm
      const s = d3.least(window.global.tracksData.series.slice(0,201), d => Math.abs(d.values[i] - ym)); // retourne les taux de chômage tels que la distance entre ym et ces taux à la date xm soit minimale
      const dateFormat = d3.timeFormat("%d/%m/%Y"); // on change le format des dates pour un plus joli affichage
      path.attr("stroke", d => {
          return d === s ? window.global.trackColorScale(s.mean) : "#ddd"
        })
        .filter(d => d === s).raise(); // trace une ligne avec les valeurs précédentes, raise() sert à faire passer cette ligne au premier plan
      
        

      dot.attr("transform", () => {
        var a = window.global.tracksX(window.global.tracksData.dates[i])
        var b = window.global.tracksY(s.values[i])


        if(pointer[1] - 170 <= 0){
          dot.select("#polyLineTracks")
              .attr("transform", "translate(-215, 30)");
          d3.selectAll(".trackText")
            .attr("transform", "translate(0, 200)");
        } else {
          dot.select("#polyLineTracks")
              .attr("transform", "translate(-215, -170)");
          d3.selectAll(".trackText")
            .attr("transform", "translate(0, 0)");
        }

        return `translate(${a},${b})`
      }); // translation

      var t = window.global.fullTracks.get(s.trackId)[0]
      var al = window.global.fullAlbums.get(t.album)[0].name
      var ar = window.global.fullArtists.get(t.artists[0])[0].name
      t = t.name

      var count = 25;

      dot.select("#dot-name")
        .text(t); 
      
      d3.select('#dot-date')
        .text(() => {
          var tt = "Artist :  " + ar
          return tt.slice(0, count) + (tt.length > count ? "..." : "");
        }); 
      
      d3.select('#dot-values')
          .text(() => {
            var tt = "Album :  "+ al
            return tt.slice(0, count) + (tt.length > count ? "..." : "");
          }); 

      d3.select('#dot-listen')
          .text(() => {
            var tt = dateFormat(window.global.tracksData.dates[i])
            return tt.slice(0, count) + (tt.length > count ? "..." : "");
          }); 

      d3.select('#dot-datee')
          .text(() => {
            var tt = ""+s.values[i].toFixed(2)+" minute(s)"
            return tt.slice(0, count) + (tt.length > count ? "..." : "");
          }); 
      
    }
    
    
  // définit ce qu'il se passe à l'entrée de la souris dans le graphe
    function entered() {
      path.style("mix-blend-mode", null).attr("stroke", "#ddd");
      dot.attr("display", null); // aucun affichage
    }

  // définit ce qu'il se passe à la sortie de la souris dans le graphe
    function left() {
      path.style("mix-blend-mode", "multiply").attr("stroke", (d,a,b) => {
        
        return window.global.trackColorScale(d.mean)
      });
      dot.attr("display", "none"); // aucun affichage
    }
  }

  function artistsDetails() {

    // https://codepen.io/zakariachowdhury/pen/EZeGJy

    const groupedHistoryByTracks = d3.group(
      window.global.historyFiltered,
      (d) => d.trackId
    );

    const tracks = Array.from(groupedHistoryByTracks, ([key, values]) => ({
      trackId: key,
      totalTs: d3.sum(values, (d) => d.ms_played),
    }));

    var artistsList = [];
    tracks.forEach((d) => {
      // Pour chaque artists présent dans la track
      if (window.global.fullTracks.get(d.trackId)) {
        window.global.fullTracks.get(d.trackId)[0].artists.forEach((a) => {
          artistsList.push({
            artist: a,
            totalTs: d.totalTs,
          });
        });
      }
    });

    artistsList = d3.group(artistsList, (d) => d.artist);
    artistsList = Array.from(artistsList, ([key, values]) => {
      if (window.global.fullArtists.get(key)) {
        return {
          artist: window.global.fullArtists.get(key)[0],
          totalTs: d3.sum(values, (d) => d.totalTs),
        };
      }

      return {
        artist: "que dalle et jcomprend pas srx",
        totalTs: 0,
      };
    });


    const totalMs = d3.sum(artistsList, (d) => d.totalTs);

    artistsList.forEach((d) => {
      d.totalTs = (d.totalTs * 100) / totalMs;
    });

    var otherArtists = artistsList.filter((a) => a.totalTs < 0.2);
    var mainArstists = artistsList.filter((a) => a.totalTs >= 0.2);

    var artistData = null;

    if (window.global.mainArtistSelected) {
      artistData = mainArstists;
    } else {
      artistData = otherArtists;
    }

    var mainArtistsProportion = d3.sum(mainArstists, (d) => d.totalTs);

    var proportions = [
      {
        title: "Top artistes",
        proportion: mainArtistsProportion,
      },
      {
        title: "Autres artistes",
        proportion: 100 - mainArtistsProportion,
      },
    ];

    /*
        artistsList.sort(function(x, y){
            return d3.descending(x.totalTs, y.totalTs);
        })
        */
    var text = "";

    var width = 400;
    var height = 400;
    var thickness = 75;

    var radius = Math.min(width, height) / 2.1;
    var color = d3.scaleOrdinal(d3.schemeCategory10);

    var donutExist = d3.select("#artistDonut").size() > 0;

    if (donutExist) {
      d3.select("#artistDonut").remove();
    }

    //--------------------------------DETAIL------------------------------------------------

    var svg = d3
      .select("#detailedArtists")
      .append("svg")
      .attr("id", "artistDonut")
      .attr("class", "pie")
      .attr("width", width)
      .attr("height", height);

    var g = svg
      .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var arc = d3
      .arc()
      .innerRadius(radius - thickness)
      .outerRadius(radius);

    var pie = d3
      .pie()
      .value(function (d) {
        return d.totalTs;
      })
      .sort(null);
    var colors = ["#3a5134","#1DB954","#000000"] 
    var path = g
      .selectAll("path")
      .data(pie(artistData))
      .enter()
      .append("g")
      .on("mouseover", function (d, data) {
        let g = d3
          .select(this)
          .style("cursor", "pointer")
          .style("fill", "black")
          .append("g")
          .attr("class", "text-group");


        g.append("text")
          .attr("class", "name-text")
          .text(`${data.data.artist.name}`)
          .attr("text-anchor", "middle")
          .attr("dy", "-1.2em");

        g.append("text")
          .attr("class", "value-text")
          .text(data.value.toFixed(4) + "%")
          .attr("text-anchor", "middle")
          .attr("dy", ".6em");
      })
      .on("mouseout", function (d) {
        d3.select(this)
          .style("cursor", "none")
          .style("fill", color(this._current))
          .select(".text-group")
          .remove();
      })
      .append("path")
      .attr("class", "piePart-detailedArtist")
      .attr("d", arc)
      //.attr("fill", (d, i) => color(i))
      //.attr("fill", (d, i) => i % 2 === 0 ? "#1DB954" : "#000000")  
      .attr("fill", (d, i) => colors[i%3])
      .on("mouseover", function (d) {
        d3.selectAll(".piePart-detailedArtist").style(
          "filter",
          "contrast(40%)"
        );

        d3.select(this).style("filter", "contrast(200%)");
      })
      .on("mouseout", function (d) {
        d3.selectAll(".piePart-detailedArtist")
          .style("filter", "contrast(100%)")
          /*.style("fill", (d, i) => {
            return color(i);
          });*/
          .attr("fill", (d, i) => i % 2 === 0 ? "#1DB954" : "#000000")  
          .attr("fill", (d, i) => colors[i%3])

      })
      .each(function (d, i) {
        this._current = i;
      });

    g.append("text")
      .attr("text-anchor", "middle")
      .attr("dy", ".35em")
      .text(text);
  }

  function artistsSelector() {

    // https://codepen.io/zakariachowdhury/pen/EZeGJy

    const groupedHistoryByTracks = d3.group(
      window.global.historyFiltered,
      (d) => d.trackId
    );

    const tracks = Array.from(groupedHistoryByTracks, ([key, values]) => ({
      trackId: key,
      totalTs: d3.sum(values, (d) => d.ms_played),
    }));

    var artistsList = [];
    tracks.forEach((d) => {
      // Pour chaque artists présent dans la track
      if (window.global.fullTracks.get(d.trackId)) {
        window.global.fullTracks.get(d.trackId)[0].artists.forEach((a) => {
          artistsList.push({
            artist: a,
            totalTs: d.totalTs,
          });
        });
      }
    });

    artistsList = d3.group(artistsList, (d) => d.artist);
    artistsList = Array.from(artistsList, ([key, values]) => {
      if (window.global.fullArtists.get(key)) {
        return {
          artist: window.global.fullArtists.get(key)[0],
          totalTs: d3.sum(values, (d) => d.totalTs),
        };
      }

      return {
        artist: "que dalle et jcomprend pas srx",
        totalTs: 0,
      };
    });


    const totalMs = d3.sum(artistsList, (d) => d.totalTs);

    artistsList.forEach((d) => {
      d.totalTs = (d.totalTs * 100) / totalMs;
    });

    var otherArtists = artistsList.filter((a) => a.totalTs < 0.2);
    var mainArstists = artistsList.filter((a) => a.totalTs >= 0.2);

    var mainArtistsProportion = d3.sum(mainArstists, (d) => d.totalTs);

    var proportions = [
      {
        title: "Top artistes",
        proportion: mainArtistsProportion,
      },
      {
        title: "Autres artistes",
        proportion: 100 - mainArtistsProportion,
      },
    ];

    /*
        artistsList.sort(function(x, y){
            return d3.descending(x.totalTs, y.totalTs);
        })
        */
    var text = "";

    var width = 400;
    var height = 400;
    var thickness = 75;

    var radius = Math.min(width, height) / 2.1;
    var color = d3.scaleOrdinal(d3.schemeCategory10);
    var colors = ["1DB954","#000000"] 

    var donutSelectorExist = d3.select("#artistSelector").size() > 0;

    if (donutSelectorExist) {
      // https://d3-graph-gallery.com/graph/pie_changeData.html

      //d3.select('#artistSelector').remove()

      svg = d3.select("#artists");
      var pie = d3
        .pie()
        .value(function (d) {
          return d.proportion;
        })
        .sort(null);

      const u = svg
        .selectAll("path")
        .data(pie(proportions))
        .join("path")
        .transition()
        .duration(1000)
        .attr(
          "d",
          d3
            .arc()
            .innerRadius(radius - thickness)
            .outerRadius(radius)
        );

      //https://stackoverflow.com/questions/51011832/d3-transition-to-count-up
      const t = d3.select("#selectorValueText");

      t.transition()
        .tween("text", () => {
          var selection = d3.select("#selectorValueText");

          var start = parseFloat(t.text().replace("%", ""));

          if (window.global.mainArtistSelected) {
            var end = proportions[0].proportion;
          } else {
            var end = proportions[1].proportion;
          }

          var interpolator = d3.interpolateNumber(start, end);


          return function (t) {
            selection.text(interpolator(t).toFixed(2) + "%");
          }; // return value
        })
        .duration(1000);
    } else {
      //--------------------------------SELECTOR------------------------------------------------
      var svg = d3
        .select("#artists")
        .append("svg")
        .attr("id", "artistSelector")
        .attr("class", "pie")
        .attr("width", width)
        .attr("height", height);

      var g = svg
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

      var arc = d3
        .arc()
        .innerRadius(radius - thickness)
        .outerRadius(radius);

      var pie = d3
        .pie()
        .value(function (d) {
          return d.proportion;
        })
        .sort(null);

      var path = g
        .selectAll("path")
        .data(pie(proportions))
        .enter()
        .append("g")
        .attr("id", (d) => {
          if (d.data.title === "Top artistes") {
            return "selectorMainArtistsG";
          }
          return "selectorOtherArtistsG";
        })
        .on("click", function (d, data) {
          d3.selectAll(".textMainOthers").remove();

          let g = d3
            .select(this)
            .style("cursor", "pointer")
            .append("g")
            .attr("class", "text-group");

          g.append("text")
            .attr("class", "name-text textMainOthers")
            .text(`${data.data.title}`)
            .attr("text-anchor", "middle")
            .attr("dy", "-1.2em");

          g.append("text")
            .attr("class", "value-text textMainOthers")
            .attr("id", "selectorValueText")
            .text(data.data.proportion.toFixed(2) + "%")
            .attr("text-anchor", "middle")
            .attr("dy", ".6em");
        })
        .append("path")
        .attr("class", "piePart")
        .attr("d", arc)
        
        .attr("fill", (d, i) => i % 2 === 0 ? "#1DB954" : "#000000")  

        .attr("id", (d) => {
          if (d.data.title === "Top artistes") {
            return "selectorMainArtistsPath";
          }
          return "selectorOtherArtistsPath";
        })
        .on("click", function (d, data) {

          d3.selectAll(".piePart").attr("fill","#000000")
          d3.select(this).attr("fill","#1DB954")

          if (data.data.title === "Top artistes") {
            window.global.mainArtistSelected = true;
          } else {
            window.global.mainArtistSelected = false;
          }

          artistsDetails();
        })
        .each(function (d, i) {
          this._current = i;
        });


      g.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", ".35em")
        .text(text);


      //document.getElementById("cc").click();

      //document.getElementById("selectorMainArtistsPath").click();
    }
  }

  function brush() {

    if(document.getElementById("rangesvg") !== null){
      d3.select('#rangesvg').remove()
    }
    const groupByDay = d3.groups(window.global.fullHistory, (d) => {
      return new Date(d.ts.toDateString());
    });

    groupByDay.forEach((day) => {
      const [i, historyOfDay] = day;
      day.msPlayedTotal = d3.sum(historyOfDay, (d) => d.ms_played);
    });

    const width = 300;
    const height = 30;

    const space = 8;

    const rangeSvg = d3
      .select("#brush")
      .append("svg")
      .attr("id", "rangesvg")
      .attr("viewBox", [0, 0, width, height]);
    //.style("background-color", "silver")

    const timeScale = d3.scaleTime(
      [d3.min(groupByDay, (h) => h[0]), d3.max(groupByDay, (h) => h[0])],
      [0, width]
    );
    const timeListenningScale = d3.scaleTime(
      [
        d3.min(groupByDay, (h) => h.msPlayedTotal),
        d3.max(groupByDay, (h) => h.msPlayedTotal),
      ],
      [0, height - space]
    );

    rangeSvg
      .append("g")
      .selectAll("rect")
      .data(groupByDay)
      .enter()
      .append("rect")
      .attr("x", (d, i) => timeScale(d[0]) - (width * 0.5) / groupByDay.length)
      .attr("y", (d, i) => {
        return height - space - timeListenningScale(d.msPlayedTotal);
      })
      .attr("fill", (d, i) => i % 2 === 0 ? "#1DB954" : "#000000")  

      .attr("width", width / groupByDay.length)
      .attr("height", (d) => timeListenningScale(d.msPlayedTotal));

    const bottomAxis = d3
      .axisBottom(timeScale)
      .ticks(d3.timeMonth.every(2))
      .tickSize(2)
      .tickFormat(function (date) {
        if (d3.timeYear(date).getMonth() < date.getMonth()) {
          return d3.timeFormat("%b")(date);
        } else {
          return d3.timeFormat("%Y")(date);
        }
      });

    const brush = d3
      .brushX()
      .extent([
        [0, 0],
        [width, height],
      ])
      .on("end", (e) => {
        window.global.startTimestampFilter = timeScale.invert(e.selection[0]);
        window.global.endTimestampFilter = timeScale.invert(e.selection[1]);
        updateAll();
      });

    rangeSvg.append("g").call(brush);

    rangeSvg
      .append("g")
      .call(bottomAxis)
      .attr(
        "transform",
        "translate(0," +
          timeListenningScale(d3.max(groupByDay, (h) => h.msPlayedTotal)) +
          ")"
      )
      .style("font-size", 3);

      rangeSvg
      .selectAll("text")
      .style("font-weight", function (d) {
            return (JSON.stringify(d).includes("-12-") ) ? "bold" : "normal";
        });
  }

  function updateAll() {

    // Reset
    window.global.historyFiltered = window.global.fullHistory;


    const startTimestampFilter = window.global.startTimestampFilter;
    const endTimestampFilter = window.global.endTimestampFilter;

    // Filter history with the selected range
    if (!(startTimestampFilter === null || startTimestampFilter === null)) {
      window.global.historyFiltered = window.global.historyFiltered.filter(
        (h) => h.ts >= startTimestampFilter && h.ts <= endTimestampFilter
      );

      var tmp1 = startTimestampFilter.toISOString().slice(0, 10).split("-");
      var tmp2 = endTimestampFilter.toISOString().slice(0, 10).split("-");

      d3.select(".dates").text(
        tmp1[2] +
          "/" +
          tmp1[1] +
          "/" +
          tmp1[0] +
          " - " +
          tmp2[2] +
          "/" +
          tmp2[1] +
          "/" +
          tmp2[0]
      );
    }

    // Updates all views
    artistsSelector();
    artistsDetails();
    topArtistsViz()
    genresViz()
    tracks()
    //brush()
  }

  function movingAverage(arr, interval) {
    let index = interval - 1;
    const length = arr.length + 1;
    let results = [];

    while (index < length) {
      index = index + 1;
      const intervalSlice = arr.slice(index - interval, index);
      const sum = intervalSlice.reduce((prev, curr) => prev + curr, 0);
      results.push(sum / interval);
    }

    return results;
  }
</script>
