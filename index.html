<head>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="dataManagement.js"></script>
</head>

<style>
    /*
    .pie text {
        font-family: "Verdana";
        fill: #888;
    }

    .pie .name-text{
        font-size: 1em;
    }

    .pie .value-text{
        font-size: 3em;
    }
    */
</style>


<body>
    <div class="container">
        <select id="subject" class="form-select" onchange="selectSubject()">
            <option selected value="Elliot">Elliot</option>
            <option value="Elodie">Elodie</option>
        </select>
    </div>

    <div class="container">
        <div id="general_viz" class="row m-0 p-1">
            <div class=" titre row my-5">
              <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
                  Les top genres musicaux
              </div>
    
              <div id="genres" class="col bg-light overflow-auto rounded m-1"> 
              </div>
    
              <div id="genres-details" class="col-2 bg-light overflow-auto rounded m-1">
              </div>
            </div>
    
            <div class="row my-5">
              <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
                Les 10 artists les plus écoutés
              </div>
              <div id="top-artists" class="col bg-light overflow-auto rounded m-1"> 
              </div>
    
              <div id="top-artists-details" class="col-2 bg-light overflow-auto rounded m-1">
              </div>
            </div>
    
            <div class="row my-5">
              <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
                Les artists 
              </div>
              <div id="artists" class="col bg-light overflow-auto rounded m-1"> 
              </div>
      
              <div id="artists-details" class="col-2 bg-light overflow-auto rounded m-1">
              </div>
              </div>
    
            <div class="row my-5">
              <div class="row bg-light overflow-auto rounded m-1 py-2 text-center">
                Les sons
              </div>
    
              <div id="songs" class="col bg-light overflow-auto rounded m-1 "> 
              </div>
    
              <div id="songs-details" class="col-2 bg-light overflow-auto rounded m-1">
              </div>
          </div>
       </div>
    </div>   
</body>

<script type="module">

    window.global = {
        subject     : document.getElementById("subject").value,
        fullHistory : null,
        fullArtists : null,
        fullAlbums  : null,
        fullTracks  : null,
        
        historyFiltered : null,
        artistFiltered : null,
        albumsFiltered : null,
        fullTracksFiltered  : null,
    }


    await loadFullData()

    window.global.historyFiltered    = window.global.fullHistory
    window.global.artistFiltered     = window.global.fullArtists
    window.global.albumsFiltered     = window.global.fullAlbums
    window.global.fullTracksFiltered = window.global.fullTracks

    console.log("ça")

    const groupedHistoryByTracks = d3.group(window.global.fullHistory, d => d.trackId)
    console.log(groupedHistoryByTracks)

    const result = Array.from(groupedHistoryByTracks, ([key, values]) => ({
        artist: key,
        totalTs: d3.sum(values, d => d.ms_played)
    }));

    const totalMs = d3.sum(result, d => d.totalTs)

    result.forEach(d=>{
        d.totalTs = d.totalTs * 100 / totalMs
    })

    result.sort(function(x, y){
        return d3.descending(x.totalTs, y.totalTs);
    })

    artists()

    function artists() {

        // https://codepen.io/zakariachowdhury/pen/EZeGJy

        /*
        var data = [
            {name: "USA", value: 40.5},
            {name: "UK", value: 20},
            {name: "Canada", value: 29.5},
            {name: "Maxico", value: 10},
        ];
        */

        const groupedHistoryByTracks = d3.group(window.global.fullHistory, d => d.trackId)
        console.log(groupedHistoryByTracks)

        const tracks = Array.from(groupedHistoryByTracks, ([key, values]) => ({
            trackId: key,
            totalTs: d3.sum(values, d => d.ms_played)
        }));


        artists = []
        tracks.forEach(d=>{
            // Pour chaque artists présent dans la track
            if(window.global.fullTracks.get(d.trackId)) {
                window.global.fullTracks.get(d.trackId)[0].artists.forEach(a => {
                    artists.push({
                        artist  : a,
                        totalTs : d.totalTs
                    })
                })
            }
        })

        artists = d3.group(artists, d => d.artist)
        artists = Array.from(artists, ([key, values]) => {

            if(window.global.fullArtists.get(key)) {
                return {
                    artist: window.global.fullArtists.get(key)[0],
                    totalTs: d3.sum(values, d => d.totalTs)
                }
            }

            return {
                artist: "que dalle et jcomprend pas srx",
                totalTs: 0
            }
        });

        console.log("artist", artists)

        const totalMs = d3.sum(artists, d => d.totalTs)

        
        artists.forEach(d=>{
            d.totalTs = d.totalTs * 100 / totalMs
        })

        /*
        artists.sort(function(x, y){
            return d3.descending(x.totalTs, y.totalTs);
        })
        */
                
        var text = "";

        var width = 400;
        var height = 400;
        var thickness = 75;

        var radius = Math.min(width, height) / 2;
        var color = d3.scaleOrdinal(d3.schemeCategory10);

        var svg = d3.select("#artists")
            .append('svg')
            .attr('class', 'pie')
            .attr('width', width)
            .attr('height', height);

        var g = svg.append('g')
            .attr('transform', 'translate(' + (width/2) + ',' + (height/2) + ')');

        var arc = d3.arc()
            .innerRadius(radius - thickness)
            .outerRadius(radius);

        var pie = d3.pie()
            .value(function(d) { return d.totalTs; })
            .sort(null);

        var path = g.selectAll('path')
            .data(pie(artists))
            .enter()
            .append("g")
            .on("mouseover", function(d,data) {
                let g = d3.select(this)
                    .style("cursor", "pointer")
                    .style("fill", "black")
                    .append("g")
                    .attr("class", "text-group");

                console.log("ARTIST",data.data.artist,window.global.fullTracks)

                g.append("text")
                    .attr("class", "name-text")
                    .text(`${data.data.artist.name}`)
                    .attr('text-anchor', 'middle')
                    .attr('dy', '-1.2em');
            
                g.append("text")
                    .attr("class", "value-text")
                    .text(`${data.value}`)
                    .attr('text-anchor', 'middle')
                    .attr('dy', '.6em');
                })
            .on("mouseout", function(d) {
                d3.select(this)
                    .style("cursor", "none")  
                    .style("fill", color(this._current))
                    .select(".text-group").remove();
                })
            .append('path')
            .attr("class", "piePart")
            .attr('d', arc)
            .attr('fill', (d,i) => color(i))
            .on("mouseover", function(d) {
                d3.selectAll(".piePart")     
                    .style("filter", "contrast(40%)")

                d3.select(this)
                    .style("filter", "contrast(200%)")        
            })
            .on("mouseout", function(d) {
                console.log("tt")
                d3.selectAll(".piePart")
                    .style("filter", "contrast(100%)")
                    .style('fill', (d,i) => {
                        return color(i)
                    })
                })
            .each(function(d, i) { this._current = i; });

        g.append('text')
            .attr('text-anchor', 'middle')
            .attr('dy', '.35em')
            .text(text);
    }


    function filterMostListen(dicoGenres,seuil) {
        var valuesArray = Object.values(dicoGenres);
        valuesArray.sort((a, b) => b - a);
        var val_seuil = valuesArray[Math.floor(valuesArray.length * seuil)];
        var filteredDicoGenre = Object.fromEntries(
            Object.entries(dicoGenres).filter(([key, value]) => value >= val_seuil)
        );
        return filteredDicoGenre;
    }

    function getFavArtists(data, nbArtists) {
            var artists =  data.map(function(value, index) {return value['master_metadata_album_artist_name']});
            var artists_count = {};

            artists.forEach(function(value, index) {
                if (value in artists_count) {
                    artists_count[value] += 1;
                } else {
                    artists_count[value] = 1;
                }
            });
            artists_count = Object.entries(artists_count).map(([name, occurrences]) => ({ name, occurrences }));
            artists_count.sort((a, b) => b.occurrences - a.occurrences);
            top_artists = artists_count.slice(0, nbArtists).map(artist => artist.name);
            return top_artists;

        }

    d3.json("datasets/occurences/occurences_genres_elliot.json").then(function (dataGenres) {
        var filteredGenres = filterMostListen(dataGenres,0.25)
        plotHist(filteredGenres,"genres");
    })

    function plotHist(dataGenres,divName){
        var tooltip = d3
            .select('#genres')
            .append('div')
            .attr('class', 'd3-tooltip')
            .style('position', 'absolute')
            .style('visibility', 'hidden')
            .style('background', 'rgba(0,0,0,0.6)')
            .style('border-radius', '4px')
            .style('color', '#fff')
        const w = Object.keys(dataGenres).length*6;
        const h = 250;
        const yScale = d3.scaleSqrt()
                .domain([1, d3.max(Object.entries(dataGenres), d => +d[1])])
                .range([0, h]);

        const barWidth = 5
        const barSpacing = 1
        const svg = d3.select("#"+divName)
                  .append("svg")
                  .attr("width", w)
                  .attr("height", h);

        const bars = svg.selectAll("rect")
                .data(Object.entries(dataGenres))
                .enter()
                .append("g");

        bars.append("rect")
                .attr("x", (d, i) => i * (barWidth + barSpacing))
                .attr("y", (d, i) => (h -  yScale(d[1]))/2)
                .attr("width", barWidth)
                .attr("height", (d, i) => (yScale(d[1])))
                .attr("fill", (d, i) => i % 2 === 0 ? "#1DB954" : "#000000")  
                .attr("class", "bar");

        d3.selectAll("rect")
                .on('mouseover', function (d, i) {
                    tooltip
                        .html(`<div>${this.__data__[0]}</div>`)
                        .style('visibility', 'visible');
                })
                .on('mouseout', function (d,i) {
                    tooltip
                        .html(``).style('visibility', 'hidden')
      });          
    }

</script>
