<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<html>
  <body class="w-screen h-screen">

    <div id="rangeDiv" class="bg-slate-600 h-2/4 w-full">

    </div>

    <script type="module">

      async function getHistory(file) {
        const raw = await d3.json('./datasets/raw/elliot/Streaming_History_Audio_2019-2020_1.json')
        return raw.map( h => {
          h.ts = new Date(h.ts)
          return h
        })
      }


      
      const elliotHistory = await getHistory('./datasets/raw/elliot/Streaming_History_Audio_2019-2020_1.json')

      const groupByDay = d3.groups(elliotHistory, (d) => {
        return new Date(d.ts.toDateString())
      })

      groupByDay.forEach(day => {
        const [i, historyOfDay] = day;
        day.msPlayedTotal = d3.sum(historyOfDay, d => d.ms_played);
      });

      //console.log(groupByDay)

      //console.log(groupByDay[0].msPlayedTotal)

      //console.log(elliotHistory)

      const width = 300
      const height = 45

      const rangeSvg =  d3.select("#rangeDiv")
        .append("svg")
        .attr("id", "rangesvg")
        .attr("viewBox", [0, 0, width, height])
        .style("background-color", "silver")

      rangeSvg.append("rect").attr("x",299).attr("y",0).attr("width",1).attr("height",1)

      const timeScale = d3.scaleTime([d3.min(groupByDay, h => h[0]), d3.max(groupByDay, h => h[0])],[0,width])
      const timeListenningScale = d3.scaleTime([d3.min(groupByDay, h => h.msPlayedTotal), d3.max(groupByDay, h => h.msPlayedTotal)],[0,height])


      rangeSvg.append("g")
              .selectAll("rect")
              .data(groupByDay)
              .enter()
              .append("rect")
              .attr("x", (d, i) => timeScale(d[0]) - width * 0.5 / groupByDay.length)
              .attr("y", (d, i) =>{
                return height-timeListenningScale(d.msPlayedTotal)
              })
              .attr("width", width / groupByDay.length)
              .attr("height", (d) => timeListenningScale(d.msPlayedTotal))

      

      const bottomAxis = d3.axisBottom(timeScale)
                           .tickFormat(d3.utcFormat("%b"));
                           //.ticks(d3.utcMonth.every(1))

      rangeSvg.append("g")
              .call(bottomAxis)
              //.attr("transform", "translate(0," + (20)+")")
              .style("font-size",3);



    </script>
    
  </body>
</html> 